# Portal + Pulumi Infrastructure

Service portal with OAuth2/OIDC authentication, managed by Pulumi TypeScript.

## Documentation

- [**How-To Guide**](docs/howto.md) - Add users, services, and activate deployments
- [**Deployment**](docs/deploy.md) - Server setup and CI/CD pipeline
- [**Architecture**](docs/architecture.md) - System design and components

## How This Repo Works

### Architecture Overview

```
infra/pulumi/     Source of truth for deployments (Pulumi TypeScript)
       |
       v
   Descriptor ──────> Portal (Rust/Axum)
   (JSON)              - Reads descriptor only
                       - No compose parsing
                       - No label discovery
       |
       v
   Docker containers managed by Pulumi:
   - Traefik (reverse proxy)
   - Keycloak (OAuth2/OIDC)
   - Portal (service dashboard)
   - OAuth2-Proxy (per protected service)
   - User services
```

### Key Principles

| Aspect | How It Works |
|--------|--------------|
| **Source of truth** | `infra/pulumi/` - Pulumi TypeScript program |
| **Service discovery** | Descriptor-only (no compose, no labels) |
| **Local environment** | HTTP only (no HTTPS) |
| **Production** | HTTPS via Traefik + ACME (HTTP-01) |
| **Pulumi state** | Pulumi Cloud (state, locking, audit history) |
| **Hostname scheme** | `portal.<domain>`, `keycloak.<domain>`, `<service>.<domain>` |
| **Image tags** | Git SHA (deterministic, no `:latest`) |

### Directory Structure

```
.
├── portal/                 # Rust portal source code
│   └── src/
│       ├── services/
│       │   └── descriptor.rs   # Descriptor v1 contract
│       └── config.rs           # Environment configuration
├── infra/
│   ├── pulumi/             # Pulumi TypeScript program
│   │   └── src/
│   │       ├── services/       # Service definitions (source of truth)
│   │       ├── descriptor.ts   # Descriptor generation (pure functions)
│   │       └── service-spec.ts # ServiceSpec type definitions
├── schema/                 # JSON Schema (single source of truth)
│   └── portal-descriptor.schema.json
├── scripts/                # Deployment scripts
│   ├── deploy-remote.sh        # Deploy script (runs on server)
│   ├── ssh-deploy-entrypoint.sh # SSH forced command entrypoint
│   └── server-bootstrap-ubuntu.sh # Server prerequisites installer
├── .github/
│   └── workflows/
│       └── deploy.yml      # CI/CD pipeline
├── docs/
│   ├── architecture.md     # System architecture
│   ├── deploy.md           # Deployment guide
│   └── howto.md            # Quick reference for common tasks
└── plan.md                 # Implementation plan
```

## Portal Descriptor (v1)

The portal reads a static JSON descriptor that defines all services. This descriptor is generated by Pulumi and injected at container startup.

### Descriptor Sources

The portal accepts the descriptor from two sources (checked in order):

| Source | Environment Variable | Use Case |
|--------|---------------------|----------|
| **JSON string** | `PORTAL_DESCRIPTOR_JSON` | Simple deployments, small descriptors |
| **File path** | `PORTAL_DESCRIPTOR_PATH` | Large descriptors, CI quoting issues |

If neither is set, the portal fails fast with an actionable error.

### Example Descriptor

```json
{
  "version": "1",
  "deploymentId": "local",
  "environment": "dev",
  "baseDomain": "localhost",
  "portal": {
    "publicUrl": "http://portal.localhost"
  },
  "keycloak": {
    "publicUrl": "http://keycloak.localhost",
    "issuerUrl": "http://keycloak.localhost/realms/dev",
    "realm": "dev"
  },
  "services": [
    {
      "id": "demo",
      "name": "Demo App",
      "url": "http://demo.localhost",
      "protected": true,
      "authType": "oauth2-proxy",
      "icon": "rocket",
      "description": "Demo application",
      "requiredRealmRoles": ["user"]
    },
    {
      "id": "docs",
      "name": "Documentation",
      "url": "http://docs.localhost",
      "protected": false,
      "authType": "none"
    }
  ]
}
```

### Descriptor Contract Rules

1. **Version**: Must be `"1"` (strict compatibility gate)
2. **No secrets**: Never include client secrets, passwords, or tokens
3. **Absolute URLs**: All `*Url` fields must have explicit `http://` or `https://` scheme
4. **Slug format**: `deploymentId` and `environment` must be non-empty, lowercase alphanumeric with hyphens
5. **Auth consistency**: `protected` must match `authType` (`protected = authType !== "none"`)
6. **Display order**: `services` array order is the display order (Pulumi produces stable ordering)

### Service Fields

| Field | Required | Description |
|-------|----------|-------------|
| `id` | Yes | Stable identifier/slug (e.g., `"demo"`, `"api"`) |
| `name` | Yes | Display name (e.g., `"Demo App"`) |
| `url` | Yes | Browser-visible URL with scheme |
| `protected` | Yes | Whether authentication is required |
| `authType` | Yes | `"portal"`, `"oauth2-proxy"`, or `"none"` |
| `group` | No | UI grouping |
| `icon` | No | Icon identifier |
| `description` | No | Short description |

## Portal Configuration

### Required Environment Variables

| Variable | Description |
|----------|-------------|
| `PORTAL_DESCRIPTOR_JSON` | Descriptor as JSON string (or use `_PATH`) |
| `PORTAL_DESCRIPTOR_PATH` | Path to descriptor JSON file |
| `KEYCLOAK_URL` | Internal Keycloak URL (e.g., `http://keycloak:8080`) |
| `KEYCLOAK_CALLBACK_URL` | Public Keycloak URL for browser redirects |
| `KEYCLOAK_REALM` | Keycloak realm name |
| `CLIENT_ID` | OAuth2 client ID |
| `CLIENT_SECRET` | OAuth2 client secret |
| `REDIRECT_URI` | OAuth2 callback URI |

### Optional Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `ENVIRONMENT` | `development` | `development` or `production` |
| `SERVER_HOST` | `0.0.0.0` | Bind address |
| `SERVER_PORT` | `3000` | Listen port |
| `COOKIE_DOMAIN` | `.localhost` | Cookie domain |

### Startup Logging

On startup, the portal logs an effective configuration summary (non-sensitive):

```
Descriptor loaded: deploymentId=local, environment=dev, baseDomain=localhost
  portal: http://localhost
  keycloak: http://keycloak.localhost
  services: 3 total (2 protected, 1 public)
```

## Development

### Quick Validation

Verify everything works before committing:

```bash
# Portal (Rust)
cd portal && cargo test

# Infrastructure (TypeScript)
cd infra/pulumi && npm install && npm test
```

### Building the Portal

```bash
cd portal
cargo build
cargo test
```

### Infrastructure Tests

```bash
cd infra/pulumi
npm install      # First time only
npm test         # Run descriptor generation tests
npm run build    # Type check
```

### Running Locally

**Prerequisites:**
1. Docker running
2. Node.js 18+
3. Wildcard `*.localhost` DNS resolution (see "Local DNS Setup" below)

**Quick Start:**

```bash
cd infra/pulumi && npm install

# Set passphrase for local development (empty is fine)
export PULUMI_CONFIG_PASSPHRASE=""

# Create a new stack
npm run new local
# → Creates Pulumi stack "local"
# → Generates config.local.yaml with example values

# Edit config.local.yaml with your settings, then load it:
npm run config:load

# Deploy
pulumi up

# Open in browser
open http://portal.localhost
```

### Configuration System

Each stack has a single config file: `config.<stack>.yaml`

**How it works:**
1. `npm run new <stack>` - Creates Pulumi stack and generates example config file
2. Edit `config.<stack>.yaml` with your settings
3. `npm run config:load` - Loads config into Pulumi (run after any config changes)
4. `pulumi up` - Deploy

**Config file structure:**

```yaml
# Stack settings
stack:
  deploymentId: local           # Unique deployment ID
  baseDomain: localhost         # Base domain for services
  environment: dev              # dev or prod
  keycloakRealm: local          # Keycloak realm name
  keycloakDevMode: true         # false for production
  # useHttps: true              # Enable for production
  # acmeEmail: admin@example.com # Required if useHttps is true

# Services to deploy (from the catalog)
services:
  demo:
    portalName: Demo App
    requiredRoles: [admin, dev]  # Omit for public services
    group: apps
    icon: rocket
    description: Demo application
  dozzle:
    portalName: Dozzle
    requiredRoles: [admin]
    group: admin
    icon: file-text
    description: Container log viewer

# Secrets (users, passwords)
secrets:
  keycloakAdminUsername: admin
  keycloakAdminPassword: admin-dev-password
  users:
    - username: admin
      password: admin
      roles: admin
      email: admin@localhost.local
```

**Important:**
- Config files are gitignored (they contain secrets)
- Run `npm run config:load` after any changes to the config file
- Set `PULUMI_CONFIG_PASSPHRASE` before running Pulumi commands (empty string is fine for local dev)

**Verify deployment:**
- http://portal.localhost - Portal dashboard
- http://keycloak.localhost - Keycloak (admin: admin/admin123)
- http://demo.localhost - Protected demo app (redirects to Keycloak)
- http://docs.localhost - Public docs (no auth)

**Login credentials:** Defined in `config.local.yaml` under `secrets.users` (default: `admin` / `admin`)

**Commands:**

```bash
# Stack management
npm run new <stack>     # Create new stack + generate config file
npm run config:load     # Load config.<stack>.yaml into Pulumi

# Pulumi
pulumi up               # Deploy
pulumi preview          # Preview changes
pulumi destroy          # Tear down
pulumi stack select <stack>  # Switch stacks
```

### Local DNS Setup

For local development, you need to resolve `*.localhost` subdomains to `127.0.0.1`. There are several approaches:

#### Option 1: /etc/hosts (Manual)

Add entries for each service:

```bash
# /etc/hosts
127.0.0.1 portal.localhost
127.0.0.1 keycloak.localhost
127.0.0.1 demo.localhost
# Add more as needed
```

**Pros**: No additional software required  
**Cons**: Must update manually when adding services

#### Option 2: dnsmasq (Recommended for macOS)

Configure dnsmasq to resolve all `*.localhost` to `127.0.0.1`:

```bash
# Install dnsmasq
brew install dnsmasq

# Configure wildcard resolution
echo "address=/localhost/127.0.0.1" >> $(brew --prefix)/etc/dnsmasq.conf

# Start dnsmasq
sudo brew services start dnsmasq

# Configure macOS to use dnsmasq for .localhost
sudo mkdir -p /etc/resolver
echo "nameserver 127.0.0.1" | sudo tee /etc/resolver/localhost
```

**Pros**: Automatic wildcard resolution, no manual updates  
**Cons**: Requires dnsmasq installation

#### Option 3: Docker Desktop DNS (Limited)

Docker Desktop on macOS/Windows automatically resolves `*.localhost` for containers. However, this only works for container-to-container communication, not from the host browser.

#### Verifying DNS Resolution

```bash
# Should resolve to 127.0.0.1
ping portal.localhost
ping keycloak.localhost
ping demo.localhost
```

If DNS is working, you should see responses from `127.0.0.1`.

### Testing with a Descriptor

```bash
# Use inline JSON (see Example Descriptor above for full structure)
export PORTAL_DESCRIPTOR_JSON='{"version":"1","deploymentId":"local",...}'
# Or create a local file and reference it:
# export PORTAL_DESCRIPTOR_PATH=/path/to/your/descriptor.json
export KEYCLOAK_URL=http://keycloak:8080
export KEYCLOAK_CALLBACK_URL=http://keycloak.localhost
export KEYCLOAK_REALM=dev
export CLIENT_ID=portal
export CLIENT_SECRET=secret
export REDIRECT_URI=http://localhost/auth/callback

cd portal
cargo run
```

## Production Deployment

Production uses HTTPS via Traefik with ACME (Let's Encrypt):

- **HTTP (port 80)**: ACME HTTP-01 challenges + redirect to HTTPS
- **HTTPS (port 443)**: All application traffic
- **Certificates**: Per-host certificates, persisted in Docker volume

GitHub Actions CI/CD:
1. `pulumi preview` on PRs and pushes to `master`
2. Manual deploy via workflow dispatch (SSHes to bare metal server)
3. State managed in Pulumi Cloud

See [`docs/deploy.md`](docs/deploy.md) for full setup and deployment instructions.

## Troubleshooting

### Portal Won't Start

**Missing descriptor**:
```
Error: Either PORTAL_DESCRIPTOR_JSON or PORTAL_DESCRIPTOR_PATH environment variable is required
```
Set one of the descriptor environment variables.

**Invalid descriptor** (parse error):
```
Error: Failed to load descriptor from PORTAL_DESCRIPTOR_JSON at line 5 column 12: missing field `version`
```
Check your JSON syntax and ensure all required fields are present.

**Validation error**:
```
Error: Descriptor validation failed (PORTAL_DESCRIPTOR_JSON):
  - services[2].url must have http:// or https:// scheme: 'demo.localhost'
  - unsupported descriptor version '2' (supported: 1)
```
Fix the indicated fields in your descriptor.

### Descriptor Too Large

If `PORTAL_DESCRIPTOR_JSON` causes shell quoting issues or exceeds environment variable limits:

1. Write descriptor to a file
2. Use `PORTAL_DESCRIPTOR_PATH=/path/to/descriptor.json` instead

## Security Notes

- The descriptor is intentionally **non-secret** - never include credentials
- Secrets are managed via Pulumi config (encrypted) and CI variables
- Production uses HTTPS everywhere
- Cookies are HttpOnly with appropriate SameSite settings
