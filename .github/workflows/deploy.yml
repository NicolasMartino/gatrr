# GitHub Actions CI/CD Pipeline
#
# Architecture:
# - Validate: Tests and builds all components in parallel
# - Preview: Runs Pulumi preview on GitHub-hosted runners
# - Deploy: SSHes to bare metal server where Pulumi runs locally
#
# Required Variables (Settings > Secrets and variables > Actions > Variables):
# - PULUMI_ORG: Your Pulumi organization name (e.g., NicolasMartino-org)
# - PULUMI_USER: Your Pulumi username (e.g., NicolasMartino) - needed for OIDC on free tier
#
# Required Secrets (Settings > Secrets and variables > Actions > Secrets):
# - PULUMI_CONFIG_PASSPHRASE: Passphrase for Pulumi config encryption (can be empty if using ESC)

name: CI/CD

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:
    inputs:
      sha:
        description: 'Commit SHA to deploy (leave empty for current commit)'
        required: false
        default: ''

env:
  PULUMI_CONFIG_PASSPHRASE: ${{ secrets.PULUMI_CONFIG_PASSPHRASE }}

jobs:
  # ===========================================================================
  # VALIDATE - All tests and builds run in parallel
  # ===========================================================================

  infra-test:
    name: Infra Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: infra/pulumi
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20.17'
          cache: 'npm'
          cache-dependency-path: infra/pulumi/package-lock.json

      - run: npm ci
      - run: npm test
      - run: npm run lint
      - run: npm run build

  portal-test:
    name: Portal Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: portal
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20.17'
          cache: 'npm'
          cache-dependency-path: portal/package-lock.json

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: portal

      - name: Build CSS
        run: npm ci && npm run build:css

      - name: Cargo test
        run: cargo test

      - name: Cargo build (release)
        run: cargo build --release

  # ===========================================================================
  # PREVIEW
  # ===========================================================================

  preview:
    name: Preview (prod)
    runs-on: ubuntu-latest
    needs: [infra-test, portal-test]
    if: github.event.pull_request.head.repo.fork != true
    permissions:
      id-token: write
      contents: read
    defaults:
      run:
        working-directory: infra/pulumi
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20.17'
          cache: 'npm'
          cache-dependency-path: infra/pulumi/package-lock.json

      - run: npm ci
      - run: npm run build

      - uses: pulumi/auth-actions@v1
        with:
          organization: ${{ vars.PULUMI_ORG }}
          requested-token-type: urn:pulumi:token-type:access_token:personal
          scope: user:${{ vars.PULUMI_USER }}

      - uses: pulumi/actions@v5
        with:
          command: preview
          stack-name: prod
          work-dir: infra/pulumi
          diff: true

  # ===========================================================================
  # DEPLOY
  # ===========================================================================

  deploy:
    name: Deploy (prod)
    runs-on: ubuntu-latest
    needs: [preview]
    if: github.ref == 'refs/heads/master' && github.event_name == 'workflow_dispatch'
    environment:
      name: prod
    permissions:
      id-token: write
      contents: read
    concurrency:
      group: deploy-prod
      cancel-in-progress: false
    steps:
      - uses: pulumi/auth-actions@v1
        with:
          organization: ${{ vars.PULUMI_ORG }}
          requested-token-type: urn:pulumi:token-type:access_token:personal
          scope: user:${{ vars.PULUMI_USER }}

      - name: Get deploy secrets from ESC
        run: |
          set +x
          command -v jq >/dev/null || { echo "Error: jq is required"; exit 1; }
          curl -fsSL https://get.pulumi.com | sh
          export PATH="$HOME/.pulumi/bin:$PATH"

          pulumi env open ${{ vars.PULUMI_ORG }}/gatrr/prod --format json > /tmp/esc.json

          DEPLOY_HOST=$(jq -r '.ssh.deployHost' /tmp/esc.json)
          PRIVATE_KEY=$(jq -r '.ssh.privateKey' /tmp/esc.json)
          KNOWN_HOSTS=$(jq -r '.ssh.knownHosts' /tmp/esc.json)

          echo "::add-mask::$PRIVATE_KEY"
          echo "::add-mask::$DEPLOY_HOST"

          mkdir -p ~/.ssh
          echo "$PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          echo "$KNOWN_HOSTS" > ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

          echo "DEPLOY_HOST=$DEPLOY_HOST" >> $GITHUB_ENV
          rm -f /tmp/esc.json

      - name: Deploy to prod
        run: |
          sha="${{ inputs.sha || github.sha }}"
          echo "Deploying SHA: ${sha}"
          ssh ${{ env.DEPLOY_HOST }} "deploy prod ${sha}"

      - name: Cleanup SSH keys
        if: always()
        run: rm -f ~/.ssh/id_ed25519
