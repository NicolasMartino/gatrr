# GitHub Actions CI/CD Pipeline
#
# Architecture:
# - Preview: Runs on GitHub-hosted runners to show Pulumi diff
# - Deploy: SSHes to bare metal server where Pulumi runs locally
#
# This approach is required because Docker images are built with skipPush: true,
# meaning builds must happen on the target Docker daemon.
#
# Authentication:
# - Uses Pulumi ESC via OIDC (no long-lived secrets in GitHub)
# - SSH credentials fetched from ESC environment at runtime
#
# Required Variables (Settings > Secrets and variables > Actions > Variables):
# - PULUMI_ORG: Your Pulumi organization name (e.g., NicolasMartino-org)
# - PULUMI_USER: Your Pulumi username (e.g., NicolasMartino) - needed for OIDC on free tier
#
# See docs/deploy.md for full setup instructions.

name: CI/CD

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:
    inputs:
      sha:
        description: 'Commit SHA to deploy (leave empty for current commit)'
        required: false
        default: ''

env:
  PULUMI_DIR: infra/pulumi
  NODE_VERSION: '20.17'

jobs:
  # ===========================================================================
  # VALIDATE
  # ===========================================================================

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.PULUMI_DIR }}/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: ${{ env.PULUMI_DIR }}

      - name: Run tests
        run: npm test
        working-directory: ${{ env.PULUMI_DIR }}

  lint:
    name: Lint & Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.PULUMI_DIR }}/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: ${{ env.PULUMI_DIR }}

      - name: Lint
        run: npm run lint
        working-directory: ${{ env.PULUMI_DIR }}

      - name: Build
        run: npm run build
        working-directory: ${{ env.PULUMI_DIR }}

  # ===========================================================================
  # PREVIEW
  # ===========================================================================

  preview:
    name: Preview (prod)
    runs-on: ubuntu-latest
    needs: [test, lint]
    # Skip for fork PRs (OIDC not available)
    if: github.event.pull_request.head.repo.fork != true
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.PULUMI_DIR }}/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: ${{ env.PULUMI_DIR }}

      - name: Build
        run: npm run build
        working-directory: ${{ env.PULUMI_DIR }}

      # Authenticate to Pulumi via OIDC (no PULUMI_ACCESS_TOKEN needed)
      # Free tier requires personal tokens with user scope
      - uses: pulumi/auth-actions@v1
        with:
          organization: ${{ vars.PULUMI_ORG }}
          requested-token-type: urn:pulumi:token-type:access_token:personal
          scope: user:${{ vars.PULUMI_USER }}

      - uses: pulumi/actions@v5
        with:
          command: preview
          stack-name: prod
          work-dir: ${{ env.PULUMI_DIR }}
          diff: true

  # ===========================================================================
  # DEPLOY
  # ===========================================================================

  deploy:
    name: Deploy (prod)
    runs-on: ubuntu-latest
    needs: [preview]
    if: github.ref == 'refs/heads/master' && github.event_name == 'workflow_dispatch'
    environment:
      name: prod
    permissions:
      id-token: write
      contents: read
    concurrency:
      group: deploy-prod
      cancel-in-progress: false
    steps:
      # Authenticate to Pulumi via OIDC (personal token for free tier)
      - uses: pulumi/auth-actions@v1
        with:
          organization: ${{ vars.PULUMI_ORG }}
          requested-token-type: urn:pulumi:token-type:access_token:personal
          scope: user:${{ vars.PULUMI_USER }}

      # Fetch SSH secrets from Pulumi ESC
      - name: Get deploy secrets from ESC
        run: |
          set +x  # Ensure no command tracing

          # Install Pulumi CLI
          curl -fsSL https://get.pulumi.com | sh
          export PATH="$HOME/.pulumi/bin:$PATH"

          # Fetch secrets from ESC environment
          pulumi env open ${{ vars.PULUMI_ORG }}/gatrr/prod --format json > /tmp/esc.json

          # Extract SSH credentials
          DEPLOY_HOST=$(jq -r '.ssh.deployHost' /tmp/esc.json)
          PRIVATE_KEY=$(jq -r '.ssh.privateKey' /tmp/esc.json)
          KNOWN_HOSTS=$(jq -r '.ssh.knownHosts' /tmp/esc.json)

          # Register secrets for GitHub log masking (prevents accidental leaks)
          echo "::add-mask::$PRIVATE_KEY"
          echo "::add-mask::$DEPLOY_HOST"

          # Setup SSH
          mkdir -p ~/.ssh
          echo "$PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          echo "$KNOWN_HOSTS" > ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

          # Export for next step (masked, won't appear in logs)
          echo "DEPLOY_HOST=$DEPLOY_HOST" >> $GITHUB_ENV

          # Cleanup sensitive file immediately
          rm -f /tmp/esc.json

      - name: Deploy to prod
        run: |
          sha="${{ inputs.sha || github.sha }}"
          echo "Deploying SHA: ${sha}"
          ssh ${{ env.DEPLOY_HOST }} "deploy prod ${sha}"

      - name: Cleanup SSH keys
        if: always()
        run: rm -f ~/.ssh/id_ed25519
