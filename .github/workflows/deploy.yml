# GitHub Actions CI/CD Pipeline
#
# Architecture:
# - Preview: Runs on GitHub-hosted runners to show Pulumi diff
# - Deploy: SSHes to bare metal server where Pulumi runs locally
#
# This approach is required because Docker images are built with skipPush: true,
# meaning builds must happen on the target Docker daemon.
#
# Required Secrets (Settings > Secrets and variables > Actions):
#
# | Secret              | Description                                      |
# |---------------------|--------------------------------------------------|
# | SSH_PRIVATE_KEY     | Ed25519 private key for deployer                 |
# | SSH_KNOWN_HOSTS     | Output of ssh-keyscan -t ed25519 <host>          |
# | PULUMI_ACCESS_TOKEN | Pulumi Cloud token (for preview job)             |
# | DEPLOY_HOST         | Deploy target, e.g. deployer@your-server.example |
#
# See docs/deploy.md for full setup instructions.

name: CI/CD

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:
    inputs:
      sha:
        description: 'Commit SHA to deploy (leave empty for current commit)'
        required: false
        default: ''

env:
  PULUMI_DIR: infra/pulumi
  NODE_VERSION: '20.17'

jobs:
  # ===========================================================================
  # VALIDATE
  # ===========================================================================

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.PULUMI_DIR }}/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: ${{ env.PULUMI_DIR }}

      - name: Run tests
        run: npm test
        working-directory: ${{ env.PULUMI_DIR }}

  lint:
    name: Lint & Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.PULUMI_DIR }}/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: ${{ env.PULUMI_DIR }}

      - name: Lint
        run: npm run lint
        working-directory: ${{ env.PULUMI_DIR }}

      - name: Build
        run: npm run build
        working-directory: ${{ env.PULUMI_DIR }}

  # ===========================================================================
  # PREVIEW
  # ===========================================================================

  preview:
    name: Preview (staging)
    runs-on: ubuntu-latest
    needs: [test, lint]
    # Skip for fork PRs (secrets not available)
    if: github.event.pull_request.head.repo.fork != true
    env:
      PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.PULUMI_DIR }}/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: ${{ env.PULUMI_DIR }}

      - name: Build
        run: npm run build
        working-directory: ${{ env.PULUMI_DIR }}

      - uses: pulumi/actions@v5
        with:
          command: preview
          stack-name: staging
          work-dir: ${{ env.PULUMI_DIR }}
          diff: true

  # ===========================================================================
  # DEPLOY
  # ===========================================================================

  deploy:
    name: Deploy (staging)
    runs-on: ubuntu-latest
    needs: [preview]
    if: github.ref == 'refs/heads/master' && github.event_name == 'workflow_dispatch'
    environment:
      name: staging
    concurrency:
      group: deploy-staging
      cancel-in-progress: false
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          echo "${{ secrets.SSH_KNOWN_HOSTS }}" > ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Deploy to staging
        run: |
          sha="${{ inputs.sha || github.sha }}"
          echo "Deploying SHA: ${sha}"
          ssh ${{ secrets.DEPLOY_HOST }} "deploy staging ${sha}"
